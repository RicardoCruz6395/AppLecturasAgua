<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon" href="images/apple-touch-icon.png" />
        <link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" href="images/apple-touch-startup-image-640x1096.png">
        <meta http-equiv="Content-Security-Policy" content="default-src *; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
        <title>ACD Lecturas</title>
        <link type="text/css" rel="stylesheet" href="css/themes/default/jquery.mobile-1.4.5.css" />
        <link type="text/css" rel="stylesheet" href="style.css" />
        <link type="text/css" rel="stylesheet" href="css/colors/blue.css" />
        <link type="text/css" rel="stylesheet" href="css/swipebox.css" />
        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
        <script type="text/javascript" src="js/jquery.swipebox.js"></script>
        <script type="text/javascript" src="js/jquery.mobile-custom.js"></script>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
    </head>
    <body>
        <div data-role="page" id="contact" class="secondarypage" data-theme="b">
            <div data-role="header" data-position="fixed">
                <div class="nav_left_button"><a href="#" class="nav-toggle"><span></span></a></div>
                <div class="nav_center_logo">SINCRONIZAR</div>
                <div class="nav_right_button"><a href="#right-panel"><img src="images/icons/white/user.png" alt="" title="" /></a></div>
                <div class="clear"></div>
            </div><!-- /header -->
            <div role="main" class="ui-content">
                <div class="pages_maincontent">
                <div id="resultado"></div>
                    <div class="form_logo">Subir lecturas al sistema</div>
                    <div class="page_content"> 
                        <button id="appSistema" class="form_submit">Aplicación &rarr; Sistema</button>
                    </div>
                    <div class="form_logo">Bajar lecturas a la aplicación </div>
                    <div class="page_content"> 
                        <button id="sistemaApp" class="form_submit">Sistema &rarr; Aplicación</button>
                    </div>
                    <div class="form_logo"><span class="text-danger">¡Cuidado!</span><br>
                        Estos procesos pueden reemplazar lecturas de agua
                    </div>
                    <div id="resultado"></div>
                </div>
            </div><!-- /content -->
            <div data-role="panel" id="left-panel" data-display="reveal" data-position="left">
                <nav class="main-nav">
                    <ul>
                        <li>
                            <a href="tomar_lectura.html" data-transition="slidefade"><img src="images/icons/white/team.png" alt="" title="" /><span>Scanear</span></a>
                        </li>
                        <li>
                            <a href="lecturas.html" data-transition="slidefade"><img src="images/icons/white/settings.png" alt="" title="" /><span>Lecturas</span></a>
                        </li>
                        <li>
                            <a href="sincronizar.html" data-transition="slidefade"><img src="images/icons/white/settings.png" alt="" title="" /><span>Sincronizar</span></a>
                        </li>
                    </ul>
                </nav>
            </div>

            <div data-role="panel" id="right-panel" data-display="reveal" data-position="right">
                <div class="user_login_info">
                    <div class="user_details">
                        <p>Sarah Williams</p>
                    </div>
                    <nav class="user-nav">
                        <ul>
                            <li><a href="features.html"><img src="images/icons/white/settings.png" /><span>Configuración</span></a></li>
                            <li><a href="#" onclick="app.salir()"><img src="images/icons/white/lock.png" /><span>Salir</span></a></li>
                        </ul>
                    </nav>
                </div>
                <div class="close_loginpopup_button"><a href="#" data-rel="close"><img src="images/icons/white/menu_close.png" alt="" title="" /></a></div>
            </div>
            <script type="text/javascript">
                var app = {

                    db : 
                        window.openDatabase('LecturasAppDB.db', '1.0', 'LecturasAppDB', 200000)
                    ,

                    botonSistemaApp :
                        document.getElementById('sistemaApp')
                    ,

                    botonAppSistema :
                        document.getElementById('appSistema')
                    ,

                    cambiarBotones : function(){
                        app.botonAppSistema.disabled = !app.botonAppSistema.disabled;
                        app.botonSistemaApp.disabled = !app.botonSistemaApp.disabled;
                    },

                    iniciar : function(){
                        app.botonSistemaApp.addEventListener('click', app.sincronizarSistemaApp);
                        app.botonAppSistema.addEventListener('click', app.sincronizarAppSistema);
                    },
                    
                    checarConexion : function(){
                        var networkState = navigator.connection.type;

                        var states = {};
                        states[Connection.UNKNOWN]  = 'Unknown connection';
                        states[Connection.ETHERNET] = 'Ethernet connection';
                        states[Connection.WIFI]     = 'WiFi connection';
                        states[Connection.CELL_2G]  = 'Cell 2G connection';
                        states[Connection.CELL_3G]  = 'Cell 3G connection';
                        states[Connection.CELL_4G]  = 'Cell 4G connection';
                        states[Connection.CELL]     = 'Cell generic connection';
                        states[Connection.NONE]     = 'No network connection';
                        console.log('Connection type: ' + states[networkState]);


                        if( networkState != Connection.NONE && networkState != Connection.UNKNOWN ){
                            return true;
                        }else{
                            navigator.notification.beep(1);
                            app.vibrar();
                            //navigator.notification.alert('No cuenta con conexión a Internet. Intente de nuevo', function(){},'¡ ATENCIÓN !','Aceptar')
                            return false;
                        }

                    },

                    sincronizarSistemaApp : function(){

                        if( app.checarConexion() ){
                            navigator.notification.beep(1);
                            app.vibrar();
                            navigator.notification.confirm('Se reemplazarán las lecturas de la aplicación que no haya subido al sistema. ¿Continuar?',function( btn ){
                                    /* input :
                                        1 -> ok
                                        2 -> cancel
                                    */
                                    if( btn == 1 ){
                                        var request = $.ajax({
                                            type: 'POST',
                                            crossDomain: true,
                                            url: 'http://app.acd.mx/',
                                            beforeSend : app.cambiarBotones,
                                            success : app.vaciarTablas,
                                        });

                                        request.fail(function (jqXHR, textStatus, errorThrown){
                                            alert('Error en petición: ' + textStatus);
                                            app.cambiarBotones();
                                        });
                                    }
                            },'¡ ATENCIÓN !', ['Aceptar','Cancelar']);
                        }
                        
                    },

                    sincronizarAppSistema : function(){
                        if( !app.checarConexion() ){
                            app.db.transaction( function(tx){
                                tx.executeSql('SELECT * FROM lecturas WHERE modificado = "1";',[],function(tx, results){
                                    console.log(results.rows)

                                    var detectadas = results.rows.length;
                            
                                    navigator.notification.beep(1);
                                    app.vibrar();

                                    navigator.notification.confirm('Se detectaron ' + detectadas + ' lecturas modificadas . ¿Continuar?',function( btn ){
                                            /* input :
                                                1 -> ok
                                                2 -> cancel
                                            */
                                            if( btn == 1 ){
                                                alert('mandando petición para subir')
                                                /*
                                                var request = $.ajax({
                                                    type: 'POST',
                                                    crossDomain: true,
                                                    url: 'http://app.acd.mx/',
                                                    beforeSend : app.cambiarBotones,
                                                    success : app.vaciarTablas,
                                                });s

                                                request.fail(function (jqXHR, textStatus, errorThrown){
                                                    alert('Error en petición: ' + textStatus);
                                                    app.cambiarBotones();
                                                });*/
                                            }
                                    },'¡ ATENCIÓN !', ['Aceptar','Cancelar']);
                                }, app.eror);
                            }, app.error, app.exito);
                        }
                    },

                    vaciarTablas : function( informacionRecibida ){
                        app.db.transaction(function(tx){
                            tx.executeSql('DELETE FROM fraccionamientos');
                            tx.executeSql('DELETE FROM zonas');
                            tx.executeSql('DELETE FROM lecturas');
                        }, app.error, app.guardarMedidoresEnApp( informacionRecibida ) );
                    },
                    
                    guardarMedidoresEnApp : function( medidores ){
                        app.vibrar();
                        navigator.notification.alert('Se han eliminado las lecturas de la aplicación',function(){

                            if( app.guardarMedidores(medidores) ){
                                alert('Sincronización terminada')
                                app.cambiarBotones();
                            }
                            
                        },'¡ ATENCIÓN !','Aceptar')
                    },

                    guardarMedidores : function( medidores ){
                        for (var id_fracc in medidores ) {

                            // Insertar el fraccionamiento
                            var fraccionamiento = medidores[id_fracc];
                            
                            app.insertarFraccionamiento( id_fracc, fraccionamiento.nombre );
                            // Preguntar si hay zonas en el fraccionamiento
                            if( typeof fraccionamiento.zonas === "object"){
                                var zonas = fraccionamiento.zonas;
                                for (var id_zona in zonas ) {
                                    // Insertar zona del fraccionamiento
                                    var zona = zonas[id_zona];
                                    
                                    app.insertarZona( id_zona, id_fracc, zona.nombre );
                                    // Preguntar si la zona tiene medidores
                                    if( typeof zona.lecturas === "object"){
                                        var lecturas = zona.lecturas;
                                        for (var fk_residente in lecturas ) {
                                            // Insertar medidor de la zona
                                            // 0 -> Medidor
                                            // 1 -> Nombre de residente
                                            // 2 -> Lectura anterior
                                            // 3 -> Lectura nueva
                                            // 4 -> Consumo
                                            // 5 -> Promedio
                                            // 6 -> Diferencia
                                            // 7 -> Fecha
                                            // 8 -> Hora
                                            
                                            var medidor = lecturas[ fk_residente ];
                                            var datos = [ fk_residente, id_zona, medidor[0], medidor[1], medidor[5], medidor[2], medidor[3], medidor[7], 0 ];
                                            app.insertarMedidor( datos );
                                        }
                                    }
                                }
                            }
                        }
                        return true;
                    },

                    insertarFraccionamiento : function( id, nombre ){
                        var cadena = 'INSERT INTO fraccionamientos(id, nombre) VALUES (?,?)';
                        app.db.transaction(function(tx){
                            tx.executeSql(cadena, [id, nombre]);
                        }, app.error, function(){
                            app.botonSistemaApp.innerHTML = 'Fraccionamiento : ' + nombre;
                        });
                    },

                    insertarZona : function( id, id_fracc, nombre ){
                        var cadena = 'INSERT INTO zonas(id, fracc_id, nombre) VALUES (?,?,?)';
                        app.db.transaction(function(tx){
                            tx.executeSql(cadena, [id, id_fracc, nombre]);
                        }, app.error, function(){
                            app.botonSistemaApp.innerHTML = 'Zona agregada : ' + nombre;
                        });
                    },

                    insertarMedidor : function( datos ){
                        var cadena = 'INSERT INTO lecturas(fk, zona_id, medidor, residente, promedio, anterior, actual, fecha, modificado) VALUES (?,?,?,?,?,?,?,?,?)';
                        app.db.transaction(function(tx){
                            tx.executeSql(cadena, datos );
                        }, app.error, function(){
                            app.botonSistemaApp.innerHTML = 'Medidor agregado : ' + datos[2];
                        });
                    },
                    
                    vibrar : function(){
                        navigator.vibrate(700);
                    },
                    
                    error : function(e){
                        alert('Sucedió un error. Código ' + e.code + ': '+ e.message);
                    },

                    exito : function(){
                        alert('Lecturas del Sistema a la Aplicación sincronizadas correctamente! ')
                    },

                    salir : function(){
                        navigator.app.exitApp();
                    }
                    
                };

                document.addEventListener('deviceready', function(){
                    if('addEventListener' in document){
                        try{
                            app.iniciar();
                        }catch(e){
                            document.write('error')
                        }
                    }
                }, false);
            </script>
        </div>
    </body>
</html>