<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon" href="images/apple-touch-icon.png" />
        <link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" href="images/apple-touch-startup-image-640x1096.png">
        <meta name="author" content="acd.mx" />
        <meta name="description" content="ACD Lecturas App" />
        <title>ACD Lecturas</title>
        <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.4.5.css">
        <link type="text/css" rel="stylesheet" href="style.css" />
        <link type="text/css" rel="stylesheet" href="css/colors/blue.css" />
        <link type="text/css" rel="stylesheet" href="css/swipebox.css" />
        <script src="js/jquery.min.js"></script>
        <script src="js/jquery.mobile-1.4.5.min.js"></script>
        <script type="text/javascript" src="js/jquery.swipebox.js"></script>
        <script src="js/jquery.mobile-custom.js"></script>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
    </head>
    <body>
        <div data-role="page" id="contact" class="secondarypage" data-theme="b">
            <div data-role="header" data-position="fixed">
                <div class="nav_left_button"><a href="#" class="nav-toggle"><span></span></a></div>
                <div class="nav_center_logo">TOMAR LECTURA</div>
                <div class="nav_right_button"><a href="#right-panel"><img src="images/icons/white/user.png" alt="" title="" /></a></div>
                <div class="clear"></div>
            </div><!-- /header -->
            <div role="main" class="ui-content">
               <div class="pages_maincontent">
                    <div class="form_logo">M E D I D O R</div>
                    <div class="page_content"> 
        		            <h2 id="Note"></h2>
                        <div class="contactform">
                            <form class="cmxform" action="#">
                                <input type="text" id="medidor" value="" class="form_input required" data-role="none" />
                                <input type="button" class="form_submit" id="submit" data-role="none" value="Buscar" />
                            </form>
                            <button id="scanner">Scanner QR</button>
                        </div>
                        <div id="datosMedidor">
                            
                        </div>
                    </div>
                </div>
            </div><!-- /content -->
            <div data-role="panel" id="left-panel" data-display="reveal" data-position="left">
                <nav class="main-nav">
                    <ul>
                        <li>
                            <a href="tomar_lectura.html" data-transition="slidefade"><img src="images/icons/white/team.png" alt="" title="" /><span>Scanear</span></a>
                        </li>
                        <li>
                            <a href="lecturas.html" data-transition="slidefade"><img src="images/icons/white/settings.png" alt="" title="" /><span>Lecturas</span></a>
                        </li>
                        <li>
                            <a href="sincronizar.html" data-transition="slidefade"><img src="images/icons/white/settings.png" alt="" title="" /><span>Sincronizar</span></a>
                        </li>
                        <li>
                            <a href="subir.html" data-transition="slidefade"><img src="images/icons/white/blog.png" alt="" title="" /><span>Subir</span></a>
                        </li>
                    </ul>
                </nav>
            </div>

            <div data-role="panel" id="right-panel" data-display="reveal" data-position="right">
                <div class="user_login_info">
                    <div class="user_thumb_container">
                        <img src="images/profile.jpg" alt="" title="" /> 
                        <div class="user_thumb">
                            <img src="images/author.jpg" alt="" title="" />     
                        </div>  
                    </div>
                    <div class="user_details">
                        <p>Sarah Williams</p>
                    </div>
                    <nav class="user-nav">
                        <ul>
                            <li><a href="features.html"><img src="images/icons/white/settings.png" alt="" title="" /><span>Settings</span></a></li>
                            <li><a href="features.html"><img src="images/icons/white/briefcase.png" alt="" title="" /><span>Account</span></a></li>
                            <li><a href="features.html"><img src="images/icons/white/message.png" alt="" title="" /><span>Messages</span><strong class="yellow">12</strong></a></li>
                            <li><a href="features.html"><img src="images/icons/white/download.png" alt="" title="" /><span>Downloads</span><strong class="yellow">5</strong></a></li>
                            <li><a href="index.html"><img src="images/icons/white/lock.png" alt="" title="" /><span>Logout</span></a></li>
                        </ul>
                    </nav>
                </div>
                <div class="close_loginpopup_button"><a href="#" data-rel="close"><img src="images/icons/white/menu_close.png" alt="" title="" /></a></div>
            </div>
            <style>
                table {
                    width: 94%;
                    margin: 0 auto;
                }

                td {
                    padding: 2px 5px;
                }
                .right {
                    text-align: right;
                }

                .red {
                    color: #FF0000;
                }

                .editar {
                    background-color : #00F;
                    color: #FFF;
                    text-align: center;
                    font-weight: bold;
                    padding: 2px 14px;

                }
            </style>
            <script type="text/javascript">
                var app = {

                    db : 
                        //window.sqlitePlugin.openDatabase({name : 'LecturasAppDB.db'})
                        window.openDatabase('LecturasAppDB.db', '1.0', 'LecturasAppDB', 200000)
                    ,

                    inputMedidor :
                        document.getElementById('medidor')
                    ,

                    botonSubmit :
                        document.getElementById('submit')
                    ,

                    datosMedidor :
                        document.getElementById('datosMedidor')
                    ,

                    iniciar : function(){
                        var botonScanner = document.getElementById('scanner');
                        botonScanner.addEventListener('click', app.iniciarScanner);
                        app.botonSubmit.addEventListener('click', app.buscarMedidor);
                    },

                    iniciarScanner : function(){
                        cordova.plugins.barcodeScanner.scan(
                            function (result) {
                                cadena = result.text;
                                alert(cadena);
                                resultado = cadena.substr(8, cadena.indexOf("*") - 8 );
                                app.inputMedidor.value = resultado ;
                                app.botonSubmit.click();
                            },
                            app.errorScanner,
                            {
                                preferFrontCamera : false, // iOS and Android
                                showFlipCameraButton : true, // iOS and Android
                                showTorchButton : true, // iOS and Android
                                torchOn: false, // Android, launch with the torch switched on (if available)
                                prompt : "Por favor enfoque el QR del medidor", // Android
                                resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
                                formats : "QR_CODE,PDF_417", // default: all but PDF_417 and RSS_EXPANDED
                                orientation : "portrait", // Android only (portrait|landscape), default unset so it rotates with the device
                                disableAnimations : true, // iOS
                                disableSuccessBeep: false // iOS
                            }
                        );
                    },

                    buscarMedidor : function(){
                        var medidor = app.inputMedidor.value;
                        if( medidor != ''){

                            app.db.transaction(function(tx){
                                tx.executeSql('SELECT * FROM lecturas WHERE medidor = ?;', [medidor], app.evaluarInformacion, app.error);
                            }, app.error, app.exito);

                        }else{
                            alert('Ingrese un medidor o use el scanner');
                        }
                    },

                    evaluarInformacion : function(tx, resultados){
                        var longitud = resultados.rows.length;
                        var info = 'No se encontraron resultados';
                        if( longitud > 0){
                            if( longitud == 1 ){
                                var medidor = resultados.rows.item(0);
                                if( medidor.actual == -1 ){
                                    app.solicitarLectura( medidor );
                                }else{
                                    app.formarInformacion( resultados );
                                }
                            }else{
                                app.formarInformacion( resultados );
                            }
                        }else{
                            app.dibujarInformacion( info );
                        }
                    },

                    formarInformacion : function(resultados){
                        var longitud = resultados.rows.length;
                        var info = '';
                        for (var i = 0; i < longitud; i++) {
                            var medidor = resultados.rows.item(i);
                            var datos = {
                                medidor   : medidor.medidor,
                                residente : medidor.residente,
                                anterior  : medidor.anterior + ' m3',
                                actual    : (medidor.actual == -1) ? '- - -' : medidor.actual +' m3',
                                consumo   : (medidor.actual == -1) ? '- - -' : (medidor.actual-medidor.anterior) +' m3',
                                fecha     : (medidor.fecha == -1) ? '- - -' : medidor.fecha,
                                promedio  : medidor.promedio +' m3',
                                boton     : '<a class="editar" onclick="app.editar('+medidor.fk+')">EDITAR</a>'
                            };
                            info += app.dibujarInformacion( datos );
                        }
                        app.datosMedidor.innerHTML = info;
                    },

                    dibujarInformacion : function( datos ){
                        var info = '<table border="1">';
                            info += '<tr><td colspan="4"><b><span class="red">'+datos.medidor+'</span> - '+datos.residente+'</b></td></tr>';
                            info += '<tr><td><b>Anterior:</b></td><td class="right">'+datos.anterior+'</td>'
                                    + '<td><b>Actual:</b></td><td class="right">'+datos.actual+'</td></tr>';
                            info += '<tr><td><b>Consumo:</b></td><td class="right">'+datos.consumo+'</td>'
                                    + '<td><b>Promedio:</b></td><td class="right">'+datos.promedio+'</td></tr>';
                            info += '<tr><td><b>Fecha:</td><td class="right">'+datos.fecha+'</td>'
                                    + '<td colspan="2"><center>'+datos.boton+'</center></td></<tr>';
                            info += '</table><br>';
                        return info;
                    },

                    solicitarLectura : function( medidor ){
                        var lectura = prompt('Inserte lectura mayor/igual a '+medidor.anterior+' m3: ');
                        if( lectura != null ){
                            if( lectura != '' ){
                                if( lectura >= medidor.anterior ){
                                    app.insertarLectura( medidor, lectura);
                                }else{
                                    app.solicitarLectura( medidor );                        
                                }
                            }else{
                                alert('Ingrese una lectura correcta');
                                app.solicitarLectura(medidor);
                            }
                        }
                    },

                    insertarLectura : function(medidor, lectura){
                        app.db.transaction(function(tx){
                            var f = new Date();
                            var fecha = f.getFullYear() + '-' + (f.getMonth()+1) + '-' + f.getDate();
                            tx.executeSql('UPDATE lecturas SET actual = ?, fecha = ? WHERE fk = ?;',[ lectura, fecha, medidor.fk ],
                                app.exito, app.error);
                        }, app.error, app.buscarMedidor);
                    },

                    editar : function( fk ){
                        app.db.transaction(function(tx){
                            tx.executeSql('SELECT * FROM lecturas WHERE fk = ?;', [fk], function(tx, result){
                                app.solicitarLectura( result.rows.item(0) );
                            }, app.error);
                        }, app.error, app.exito);
                    },

                    exito : function(){

                    },

                    error : function(e){
                        alert('Sucedió un error. Código ' + e.code + ': '+ e.message);
                    },

                    errorScanner : function(err){
                        alert('Error de scanner: ' + error);
                    }

                };

                document.addEventListener('backbutton', function(){
                    /*if( localStorage.scanner == null ){
                        localStorage.setItem('scanner', 'false');
                        window.history.back();
                    }*/
                },true);

                document.addEventListener('deviceready', function(){
                    if('addEventListener' in document){
                        app.iniciar();
                    }
                }, false);
            </script>
        </div>
    </body>
</html>